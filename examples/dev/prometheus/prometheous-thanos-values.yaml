# monitoring-values.yaml

nodeExporter:
  enabled: true

kubeApiServer:
  enabled: true

kubelet:
  enabled: true

kubeProxy:
  enabled: false

kubeEtcd:
  enabled: false

kubeScheduler:
  enabled: false

coreDns:
  enabled: false

kubeControllerManager:
  enabled: false

alertmanager:
  enabled: false

grafana:
  enabled: true
  adminUser: admin
  adminPassword: admin
  service:
    type: ClusterIP

prometheus:
  thanosService:
    enabled: true
  
  # Service for external access to sidecar
  thanosServiceExternal:
    enabled: true
    type: ClusterIP
  
  extraSecret:
    ## if not set, name will be auto generated
    name: thanos-objstore-secret
    data:
      objstore.yml: |
       type: FILESYSTEM
        config:
          directory: /prometheus
    
  prometheusSpec:
    scrapeInterval: "5s"
    
    # Allow Prometheus to discover ServiceMonitors in the redis-app namespace
    serviceMonitorNamespaceSelector: {}
    
    # Empty selector means "select all" ServiceMonitors in the selected namespaces
    serviceMonitorSelector: {}

    podMonitorSelector: {}
    
    podMonitorNamespaceSelector: {}
    
    volumes: []

    volumeMounts: []

    additionalScrapeConfigs: 
      - job_name: 'istiod'
        kubernetes_sd_configs:
          - role: endpoints
        relabel_configs:
          - source_labels: [__meta_kubernetes_service_name, __meta_kubernetes_namespace]
            action: keep
            regex: istiod;istio-system
          - source_labels: [__meta_kubernetes_endpoint_port_name]
            action: keep
            regex: http-monitoring
        metrics_path: /metrics
        scheme: http
        scrape_interval: 7s

      - job_name: 'envoy-stats'
        kubernetes_sd_configs:
          - role: pod
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_container_port_name]
            action: keep
            regex: '.*-envoy-prom'
        metrics_path: /stats/prometheus
        scheme: http
        scrape_interval: 7s

    thanos:
      image: quay.io/thanos/thanos:v0.39.2
      objectStorageConfig:
        name: thanos-objstore-secret
        key: objstore.yml
